package com.simplemovie.service;

import java.time.LocalDate;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.simplemovie.entity.Booking;
import com.simplemovie.entity.Shows;
import com.simplemovie.repository.BookingRepository;
import com.simplemovie.repository.ShowsRepository;


@Service
public class BookingService {
	
	@Autowired
	BookingRepository bookingRepo;
	
	@Autowired
	ShowsRepository showRepo;
	
	public Booking bookTickets(Booking booking) {
		Shows show = showRepo.findById(
				booking.getShow().getShowId()).orElseThrow(
						() -> new RuntimeException("Show not found"));
		if(booking.getSeatsBooked() > show.getAvailableSeats()) {
			throw new RuntimeException("Not Enough Seats");
		}
		show.setAvailableSeats(
				show.getAvailableSeats()-booking.getSeatsBooked());
		booking.setBookingDate(LocalDate.now());
		showRepo.save(show);
		return bookingRepo.save(booking);
	}
	
	public List<Booking> getAllBookings() {
        return bookingRepo.findAll();
    }
	
	public void cancelBooking(Integer bookingId) {
        Booking booking = bookingRepo.findById(bookingId).orElseThrow(
        		() -> new RuntimeException("Booking not found"));

        Shows show = booking.getShow();
        show.setAvailableSeats(
            show.getAvailableSeats() + booking.getSeatsBooked()
        );

        showRepo.save(show);
        bookingRepo.deleteById(bookingId);
    }
}
